/**
 ******************************************************************************
 * @file      pqtest.c
 * @brief     电能质量测试程序.
 * @details   This file including all API functions's 
 *            implement of pqtest.c.	
 *
 * @copyright Copyrigth(C), 2008-2012,Sanxing Electric Co.,Ltd.
 ******************************************************************************
 */
 
/*-----------------------------------------------------------------------------
 Section: Includes
 ----------------------------------------------------------------------------*/
#include <stdio.h>
#include <math.h>
#include <types.h>
#include <shell.h>
#include <loglib.h>

/*-----------------------------------------------------------------------------
 Section: Type Definitions
 ----------------------------------------------------------------------------*/
/* NONE */

/*-----------------------------------------------------------------------------
 Section: Constant Definitions
 ----------------------------------------------------------------------------*/
#define PI                  (3.14159265358979f)
#define BUF_LEN             128             /**< 波形缓存点数 */
#define POINTS_PER_PERIOD   128             /**< 每周期点数 */
#define NUM_FFT             128

/*-----------------------------------------------------------------------------
 Section: Global Variables
 ----------------------------------------------------------------------------*/
/* NONE */

/*-----------------------------------------------------------------------------
 Section: Local Variables
 ----------------------------------------------------------------------------*/
static float32_t the_uabc[3][BUF_LEN];    /* 电压波形 */
static float32_t the_iabc[3][BUF_LEN];    /* 电流波形 */

static float32_t iRealArray[NUM_FFT];
static float32_t iMageArray[NUM_FFT];

#if NUM_FFT == 64
static const float32_t sin_tab[NUM_FFT] =
{
    0.000000f, 0.098017f, 0.195090f, 0.290285f,
    0.382683f, 0.471397f, 0.555570f, 0.634393f,
    0.707107f, 0.773010f, 0.831470f, 0.881921f,
    0.923880f, 0.956940f, 0.980785f, 0.995185f,
    1.000000f, 0.995185f, 0.980785f, 0.956940f,
    0.923880f, 0.881921f, 0.831470f, 0.773010f,
    0.707107f, 0.634393f, 0.555570f, 0.471397f,
    0.382683f, 0.290285f, 0.195090f, 0.098017f,
    -0.000000f, -0.098017f, -0.195090f, -0.290285f,
    -0.382684f, -0.471397f, -0.555570f, -0.634393f,
    -0.707107f, -0.773011f, -0.831470f, -0.881921f,
    -0.923880f, -0.956940f, -0.980785f, -0.995185f,
    -1.000000f, -0.995185f, -0.980785f, -0.956940f,
    -0.923880f, -0.881921f, -0.831470f, -0.773010f,
    -0.707107f, -0.634393f, -0.555570f, -0.471397f,
    -0.382683f, -0.290285f, -0.195090f, -0.098017f,
};

static const float32_t cos_tab[NUM_FFT] =
{
    1.000000f, 0.995185f, 0.980785f, 0.956940f,
    0.923880f, 0.881921f, 0.831470f, 0.773010f,
    0.707107f, 0.634393f, 0.555570f, 0.471397f,
    0.382683f, 0.290285f, 0.195090f, 0.098017f,
    -0.000000f, -0.098017f, -0.195090f, -0.290285f,
    -0.382683f, -0.471397f, -0.555570f, -0.634393f,
    -0.707107f, -0.773010f, -0.831470f, -0.881921f,
    -0.923880f, -0.956940f, -0.980785f, -0.995185f,
    -1.000000f, -0.995185f, -0.980785f, -0.956940f,
    -0.923880f, -0.881921f, -0.831470f, -0.773010f,
    -0.707107f, -0.634393f, -0.555570f, -0.471397f,
    -0.382683f, -0.290285f, -0.195090f, -0.098017f,
    0.000000f, 0.098017f, 0.195090f, 0.290285f,
    0.382684f, 0.471397f, 0.555570f, 0.634393f,
    0.707107f, 0.773011f, 0.831470f, 0.881921f,
    0.923880f, 0.956940f, 0.980785f, 0.995185f,
};
#elif NUM_FFT == 128
static const float32_t sin_tab[NUM_FFT] =
{
    0.000000f, 0.049068f, 0.098017f, 0.146730f,
    0.195090f, 0.242980f, 0.290285f, 0.336890f,
    0.382683f, 0.427555f, 0.471397f, 0.514103f,
    0.555570f, 0.595699f, 0.634393f, 0.671559f,
    0.707107f, 0.740951f, 0.773010f, 0.803208f,
    0.831470f, 0.857729f, 0.881921f, 0.903989f,
    0.923880f, 0.941544f, 0.956940f, 0.970031f,
    0.980785f, 0.989177f, 0.995185f, 0.998795f,
    1.000000f, 0.998795f, 0.995185f, 0.989177f,
    0.980785f, 0.970031f, 0.956940f, 0.941544f,
    0.923880f, 0.903989f, 0.881921f, 0.857729f,
    0.831470f, 0.803208f, 0.773010f, 0.740951f,
    0.707107f, 0.671559f, 0.634393f, 0.595699f,
    0.555570f, 0.514103f, 0.471397f, 0.427555f,
    0.382683f, 0.336890f, 0.290285f, 0.242980f,
    0.195090f, 0.146730f, 0.098017f, 0.049068f,
    -0.000000f, -0.049068f, -0.098017f, -0.146731f,
    -0.195090f, -0.242980f, -0.290285f, -0.336890f,
    -0.382684f, -0.427555f, -0.471397f, -0.514103f,
    -0.555570f, -0.595699f, -0.634393f, -0.671559f,
    -0.707107f, -0.740951f, -0.773011f, -0.803208f,
    -0.831470f, -0.857729f, -0.881921f, -0.903989f,
    -0.923880f, -0.941544f, -0.956940f, -0.970031f,
    -0.980785f, -0.989177f, -0.995185f, -0.998795f,
    -1.000000f, -0.998795f, -0.995185f, -0.989177f,
    -0.980785f, -0.970031f, -0.956940f, -0.941544f,
    -0.923880f, -0.903989f, -0.881921f, -0.857729f,
    -0.831470f, -0.803207f, -0.773010f, -0.740951f,
    -0.707107f, -0.671559f, -0.634393f, -0.595699f,
    -0.555570f, -0.514103f, -0.471397f, -0.427555f,
    -0.382683f, -0.336890f, -0.290285f, -0.242980f,
    -0.195090f, -0.146730f, -0.098017f, -0.049068f,
};

static const float32_t cos_tab[NUM_FFT] =
{
    1.000000f, 0.998795f, 0.995185f, 0.989177f,
    0.980785f, 0.970031f, 0.956940f, 0.941544f,
    0.923880f, 0.903989f, 0.881921f, 0.857729f,
    0.831470f, 0.803208f, 0.773010f, 0.740951f,
    0.707107f, 0.671559f, 0.634393f, 0.595699f,
    0.555570f, 0.514103f, 0.471397f, 0.427555f,
    0.382683f, 0.336890f, 0.290285f, 0.242980f,
    0.195090f, 0.146730f, 0.098017f, 0.049068f,
    -0.000000f, -0.049068f, -0.098017f, -0.146731f,
    -0.195090f, -0.242980f, -0.290285f, -0.336890f,
    -0.382683f, -0.427555f, -0.471397f, -0.514103f,
    -0.555570f, -0.595699f, -0.634393f, -0.671559f,
    -0.707107f, -0.740951f, -0.773010f, -0.803208f,
    -0.831470f, -0.857729f, -0.881921f, -0.903989f,
    -0.923880f, -0.941544f, -0.956940f, -0.970031f,
    -0.980785f, -0.989177f, -0.995185f, -0.998795f,
    -1.000000f, -0.998795f, -0.995185f, -0.989177f,
    -0.980785f, -0.970031f, -0.956940f, -0.941544f,
    -0.923880f, -0.903989f, -0.881921f, -0.857729f,
    -0.831470f, -0.803207f, -0.773010f, -0.740951f,
    -0.707107f, -0.671559f, -0.634393f, -0.595699f,
    -0.555570f, -0.514103f, -0.471397f, -0.427555f,
    -0.382683f, -0.336890f, -0.290285f, -0.242980f,
    -0.195090f, -0.146730f, -0.098017f, -0.049068f,
    0.000000f, 0.049068f, 0.098017f, 0.146731f,
    0.195090f, 0.242980f, 0.290285f, 0.336890f,
    0.382684f, 0.427555f, 0.471397f, 0.514103f,
    0.555570f, 0.595699f, 0.634393f, 0.671559f,
    0.707107f, 0.740951f, 0.773011f, 0.803208f,
    0.831470f, 0.857729f, 0.881921f, 0.903989f,
    0.923880f, 0.941544f, 0.956940f, 0.970031f,
    0.980785f, 0.989177f, 0.995185f, 0.998795f,
};
static const uint8_t the_xx_table[] =
{
    0x00, 0x40, 0x20, 0x60, 0x10, 0x50, 0x30, 0x70,
    0x08, 0x48, 0x28, 0x68, 0x18, 0x58, 0x38, 0x78,
    0x04, 0x44, 0x24, 0x64, 0x14, 0x54, 0x34, 0x74,
    0x0c, 0x4c, 0x2c, 0x6c, 0x1c, 0x5c, 0x3c, 0x7c,
    0x02, 0x42, 0x22, 0x62, 0x12, 0x52, 0x32, 0x72,
    0x0a, 0x4a, 0x2a, 0x6a, 0x1a, 0x5a, 0x3a, 0x7a,
    0x06, 0x46, 0x26, 0x66, 0x16, 0x56, 0x36, 0x76,
    0x0e, 0x4e, 0x2e, 0x6e, 0x1e, 0x5e, 0x3e, 0x7e,
    0x01, 0x41, 0x21, 0x61, 0x11, 0x51, 0x31, 0x71,
    0x09, 0x49, 0x29, 0x69, 0x19, 0x59, 0x39, 0x79,
    0x05, 0x45, 0x25, 0x65, 0x15, 0x55, 0x35, 0x75,
    0x0d, 0x4d, 0x2d, 0x6d, 0x1d, 0x5d, 0x3d, 0x7d,
    0x03, 0x43, 0x23, 0x63, 0x13, 0x53, 0x33, 0x73,
    0x0b, 0x4b, 0x2b, 0x6b, 0x1b, 0x5b, 0x3b, 0x7b,
    0x07, 0x47, 0x27, 0x67, 0x17, 0x57, 0x37, 0x77,
    0x0f, 0x4f, 0x2f, 0x6f, 0x1f, 0x5f, 0x3f, 0x7f,
};

static const uint8_t the_2n_table[8] =
{
   1u, 2u, 4u, 8u, 16u, 32u, 64u, 128u,
};
#else
# error "NUM_FFT error! value: 64 or 128"
#endif
/*-----------------------------------------------------------------------------
 Section: Local Function Prototypes
 ----------------------------------------------------------------------------*/
/* NONE */

/*-----------------------------------------------------------------------------
 Section: Global Function Prototypes
 ----------------------------------------------------------------------------*/
/* NONE */

/*-----------------------------------------------------------------------------
 Section: Function Definitions
 ----------------------------------------------------------------------------*/
/**
 ******************************************************************************
 * @brief   fft转换程序
 * @param[in/out]  dataR    : 实部
 * @param[in/out]  dataI    : 虚部
 *
 * @return     None
 ******************************************************************************
 */
static void
FFT(float32_t dataR[NUM_FFT], float32_t dataI[NUM_FFT])
{
    uint8_t i;
    uint8_t j;
    uint8_t b;
    uint8_t k;
    uint16_t p;
    float32_t TR, TI, temp;

    /* 倒位序算法,采用查表法加快速度 */
    for (i = 0u; i < 128u; i++)
    {
        dataI[the_xx_table[i]] = dataR[i];
    }
    for (i = 0u; i < 128u; i++)
    {
        dataR[i] = dataI[i];
        dataI[i] = 0.0f;
    }

    /* fft蝶形算法 */
    for (i = 1u; i <= 7u; i++)
    {
        /* b = 2 ^ (i - 1) */
        b = the_2n_table[i - 1u];
        for (j = 0u; j <= b - 1u; j++) /* for (2) */
        {
            /* p = pow(2, 7 - i) * j; */
            p = the_2n_table[7u - i] * j;
            for (k = j; k < 128u; k += 2u * b) /* for (3) */
            {
                TR = dataR[k];
                TI = dataI[k];
                temp = dataR[k + b];
                dataR[k] = dataR[k] + dataR[k + b] * cos_tab[p]
                        + dataI[k + b] * sin_tab[p];
                dataI[k] = dataI[k] - dataR[k + b] * sin_tab[p]
                        + dataI[k + b] * cos_tab[p];
                dataR[k + b] = TR - dataR[k + b] * cos_tab[p]
                        - dataI[k + b] * sin_tab[p];
                dataI[k + b] = TI + temp * sin_tab[p]
                        - dataI[k + b] * cos_tab[p];
            } /* END for (3) */
        } /* END for (2) */
    } /* END for (1) */
} /* END FFT */

/**
 ******************************************************************************
 * @brief   生成仿真波形数据
 * @param[in]  None
 *
 * @retval     None
 ******************************************************************************
 */
static void
generate_wave(void)
{
    int32_t i;
    for (i = 0; i < BUF_LEN; i++)
    {
        /* 基波 */
        the_uabc[0][i] = (float32_t)sin(i * (PI * 2) / POINTS_PER_PERIOD) * 220.0f;
        the_uabc[1][i] = (float32_t)sin(-PI * 2 / 3 + i * (PI * 2) / POINTS_PER_PERIOD) * 220.0f;
        the_uabc[2][i] = (float32_t)sin(-PI * 4 / 3 + i * (PI * 2) / POINTS_PER_PERIOD) * 220.0f;
#if 0
        /* 1次谐波 */
        the_uabc[0][i] += (float32_t)sin(2 * i * (PI * 2) / POINTS_PER_PERIOD) * 20.0f;
        the_uabc[1][i] += (float32_t)sin(-PI * 2 / 3 + 2 * i * (PI * 2) / POINTS_PER_PERIOD) * 20.0f;
        the_uabc[2][i] += (float32_t)sin(-PI * 4 / 3 + 2 * i * (PI * 2) / POINTS_PER_PERIOD) * 20.0f;
#endif

        the_iabc[0][i] = 0.0f;
        the_iabc[1][i] = 0.0f;
        the_iabc[2][i] = 0.0f;
    }
}

uint32_t do_pqtest (cmd_tbl_t * cmdtp,
        uint32_t argc,
        const uint8_t *argv[])
{
    printf("do pqlib test!\n");
    printf("1.生成uabc仿真波形\n");
    generate_wave();
    for (int32_t i = 0; i < NUM_FFT; i++)
    {
        iRealArray[i] = the_uabc[0][i];
        iMageArray[i] = 0.0f;
    }

    printf("2. FFT变换\n");
    FFT(iRealArray, iMageArray);
//    for (int32 i = 0; i < NUM_FFT; i++)
//    {
//        printf("iRealArray[%d]:%f ", i, iRealArray[i]);
//        printf("iMageArray[%d]:%f\n", i, iMageArray[i]);
//    }
    printf("3. 变换结果\n");
    for (int32_t i = 0; i < 10; i ++)
    {
        printf("value[%d] = %d\n", i, (uint32_t)(10000*sqrtf(iRealArray[i] * iRealArray[i] + iMageArray[i] * iMageArray[i])));
    }

    return 0;
}

SHELL_CMD(
    pqtest,  CFG_MAXARGS,        do_pqtest,
    "pqtest \r\t\t\t\t pq test\r\n"
);

/*-------------------------------pqtest.c------------------------------------*/
